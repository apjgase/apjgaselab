{"status":{},"spec":{"description":"","resources":{"client_attrs":{"b84a2406_deployment":{"y":353.5058558338,"x":1087.6235266039},"b84a2406_deployment_cloned_0":{"y":417.5,"x":742}},"service_definition_list":[{"singleton":false,"action_list":[{"description":"System action for creating an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"node1"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"31de1c7b_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"d905641e_runbook","main_task_local_reference":{"kind":"app_task","name":"31de1c7b_dag"},"variable_list":[]},"name":"action_create"},{"description":"System action for deleting an application. Deletes created VMs as well","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"node1"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"6d23afc1_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"641eb948_runbook","main_task_local_reference":{"kind":"app_task","name":"6d23afc1_dag"},"variable_list":[]},"name":"action_delete"},{"description":"System action for starting an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"node1"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"6d4b6e44_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"713ac8e0_runbook","main_task_local_reference":{"kind":"app_task","name":"6d4b6e44_dag"},"variable_list":[]},"name":"action_start"},{"description":"System action for stopping an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"node1"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"f23558ca_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"67cb24b4_runbook","main_task_local_reference":{"kind":"app_task","name":"f23558ca_dag"},"variable_list":[]},"name":"action_stop"},{"description":"System action for restarting an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"node1"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"0a2e17a6_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"bc5ab444_runbook","main_task_local_reference":{"kind":"app_task","name":"0a2e17a6_dag"},"variable_list":[]},"name":"action_restart"}],"depends_on_list":[],"name":"node1","port_list":[],"tier":"","variable_list":[{"val_type":"STRING","description":"","name":"availableip","type":"LOCAL","value":"","label":""}],"description":""},{"singleton":false,"action_list":[{"description":"System action for creating an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"node2"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"31de1c7b_dag_cloned_1","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"d905641e_runbook_cloned_0","main_task_local_reference":{"kind":"app_task","name":"31de1c7b_dag_cloned_1"},"variable_list":[]},"name":"action_create"},{"description":"System action for deleting an application. Deletes created VMs as well","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"node2"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"6d23afc1_dag_cloned_1","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"641eb948_runbook_cloned_0","main_task_local_reference":{"kind":"app_task","name":"6d23afc1_dag_cloned_1"},"variable_list":[]},"name":"action_delete"},{"description":"System action for starting an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"node2"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"6d4b6e44_dag_cloned_1","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"713ac8e0_runbook_cloned_0","main_task_local_reference":{"kind":"app_task","name":"6d4b6e44_dag_cloned_1"},"variable_list":[]},"name":"action_start"},{"description":"System action for stopping an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"node2"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"f23558ca_dag_cloned_1","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"67cb24b4_runbook_cloned_0","main_task_local_reference":{"kind":"app_task","name":"f23558ca_dag_cloned_1"},"variable_list":[]},"name":"action_stop"},{"description":"System action for restarting an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"node2"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"0a2e17a6_dag_cloned_1","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"bc5ab444_runbook_cloned_0","main_task_local_reference":{"kind":"app_task","name":"0a2e17a6_dag_cloned_1"},"variable_list":[]},"name":"action_restart"}],"depends_on_list":[],"name":"node2","port_list":[],"tier":"","variable_list":[],"description":""}],"substrate_definition_list":[{"description":"","action_list":[],"type":"AHV_VM","name":"node1vm","readiness_probe":{"connection_type":"SSH","retries":"5","disable_readiness_probe":false,"address":"@@{platform.status.resources.nic_list[0].ip_endpoint_list[0].ip}@@","delay_secs":"60","connection_port":22,"login_credential_local_reference":{"kind":"app_credential","name":"centos"}},"editables":{"create_spec":{"resources":{"nic_list":{},"serial_port_list":{},"disk_list":{}}}},"os_type":"Linux","create_spec":{"name":"node1-@@{calm_unique}@@","resources":{"nic_list":[{"nic_type":"NORMAL_NIC","ip_endpoint_list":[],"network_function_chain_reference":null,"network_function_nic_type":"INGRESS","mac_address":"","subnet_reference":{"kind":"subnet","type":"","name":"","uuid":"7303b7bd-1d31-42b0-b76f-548e493a2760"},"type":""}],"serial_port_list":[],"guest_tools":null,"num_vcpus_per_socket":2,"num_sockets":2,"gpu_list":[],"memory_size_mib":4096,"parent_reference":null,"hardware_clock_timezone":"","guest_customization":{"cloud_init":{"meta_data":"","type":"","user_data":"#cloud-config\ndisable_root: False\nssh_enabled: True\nssh_pwauth: True\nhostname: node1\n\n\n#create user\nusers:\n  - name: \"@@{centos.username}@@\"\n    groups: sudo\n    shell: \/bin\/bash\n    lock_passwd: false\n    sudo: ['ALL=(ALL) NOPASSWD:ALL']\n  \n#set password    \nchpasswd:\n list: |\n   @@{centos.username}@@:@@{centos.secret}@@\n expire: False"},"type":"","sysprep":null},"power_state":"ON","type":"","boot_config":{"boot_device":{"type":"","disk_address":{"type":"","device_index":0,"adapter_type":"SCSI"}},"type":"","mac_address":""},"disk_list":[{"data_source_reference":{"kind":"image","type":"","name":"CentOS-7-x86_64-GenericCloud","uuid":"f21322b6-6121-42f8-9035-25b4cc56ba1c"},"type":"","disk_size_mib":0,"volume_group_reference":null,"device_properties":{"type":"","disk_address":{"type":"","device_index":0,"adapter_type":"SCSI"},"device_type":"DISK"}},{"data_source_reference":null,"type":"","disk_size_mib":8192,"volume_group_reference":null,"device_properties":{"type":"","disk_address":{"type":"","device_index":1,"adapter_type":"SCSI"},"device_type":"DISK"}}]},"availability_zone_reference":null,"backup_policy":null,"type":"","cluster_reference":null,"categories":""},"variable_list":[]},{"description":"","action_list":[],"type":"AHV_VM","name":"node2vm","readiness_probe":{"connection_type":"SSH","retries":"5","disable_readiness_probe":false,"address":"@@{platform.status.resources.nic_list[0].ip_endpoint_list[0].ip}@@","delay_secs":"60","connection_port":22,"login_credential_local_reference":{"kind":"app_credential","name":"centos"}},"editables":{"create_spec":{"resources":{"nic_list":{},"serial_port_list":{},"disk_list":{}}}},"os_type":"Linux","create_spec":{"name":"node2-@@{calm_unique}@@","resources":{"nic_list":[{"nic_type":"NORMAL_NIC","ip_endpoint_list":[],"network_function_chain_reference":null,"network_function_nic_type":"INGRESS","mac_address":"","subnet_reference":{"kind":"subnet","type":"","name":"","uuid":"7303b7bd-1d31-42b0-b76f-548e493a2760"},"type":""}],"serial_port_list":[],"guest_tools":null,"num_vcpus_per_socket":2,"num_sockets":2,"gpu_list":[],"memory_size_mib":4096,"parent_reference":null,"hardware_clock_timezone":"","guest_customization":{"cloud_init":{"meta_data":"","type":"","user_data":"#cloud-config\ndisable_root: False\nssh_enabled: True\nssh_pwauth: True\nhostname: node2\n\n\n#create user\nusers:\n  - name: \"@@{centos.username}@@\"\n    groups: sudo\n    shell: \/bin\/bash\n    lock_passwd: false\n    sudo: ['ALL=(ALL) NOPASSWD:ALL']\n \n#set password    \nchpasswd:\n list: |\n   @@{centos.username}@@:@@{centos.secret}@@\n expire: False"},"type":"","sysprep":null},"power_state":"ON","type":"","boot_config":{"boot_device":{"type":"","disk_address":{"type":"","device_index":0,"adapter_type":"SCSI"}},"type":"","mac_address":""},"disk_list":[{"data_source_reference":{"kind":"image","type":"","name":"CentOS-7-x86_64-GenericCloud","uuid":"f21322b6-6121-42f8-9035-25b4cc56ba1c"},"type":"","disk_size_mib":0,"volume_group_reference":null,"device_properties":{"type":"","disk_address":{"type":"","device_index":0,"adapter_type":"SCSI"},"device_type":"DISK"}},{"data_source_reference":null,"type":"","disk_size_mib":8192,"volume_group_reference":null,"device_properties":{"type":"","disk_address":{"type":"","device_index":1,"adapter_type":"SCSI"},"device_type":"DISK"}}]},"availability_zone_reference":null,"backup_policy":null,"type":"","cluster_reference":null,"categories":""},"variable_list":[]}],"credential_definition_list":[{"username":"centos","description":"","type":"PASSWORD","secret":{"attrs":{"is_secret_modified":false,"secret_reference":{}}},"name":"centos"},{"username":"hacluster","description":"","type":"PASSWORD","secret":{"attrs":{"is_secret_modified":false,"secret_reference":{}}},"name":"hacluster"}],"package_definition_list":[{"description":"","action_list":[],"type":"DEB","service_local_reference_list":[{"kind":"app_service","name":"node1"}],"name":"cluster","version":"","options":{"install_runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_package","name":"cluster"},"retries":"0","description":"","message_list":[],"child_tasks_local_reference_list":[{"kind":"app_task","name":"Task1"},{"kind":"app_task","name":"Task2"},{"kind":"app_task","name":"Task3"},{"kind":"app_task","name":"Task4"},{"kind":"app_task","name":"Task5"},{"kind":"app_task","name":"Task7"},{"kind":"app_task","name":"Task6"}],"name":"1079dabc_dag","state":"ACTIVE","attrs":{"edges":[{"from_task_reference":{"kind":"app_task","name":"Task1"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"Task2"}},{"from_task_reference":{"kind":"app_task","name":"Task2"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"Task3"}},{"from_task_reference":{"kind":"app_task","name":"Task3"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"Task4"}},{"from_task_reference":{"kind":"app_task","name":"Task4"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"Task5"}},{"from_task_reference":{"kind":"app_task","name":"Task5"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"Task7"}},{"from_task_reference":{"kind":"app_task","name":"Task7"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"Task6"}}],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"node1"},"retries":"0","description":"","message_list":[],"child_tasks_local_reference_list":[],"name":"Task1","state":"ACTIVE","attrs":{"exit_status":[],"script":"#!\/bin\/bash\nset -ex\nsudo hostnamectl set-hostname node1\nsudo yum update -y -q\nsudo yum install -y -q pcs pacemaker fence-agents-all psmisc policycoreutils-python\nsudo rpm --import https:\/\/www.elrepo.org\/RPM-GPG-KEY-elrepo.org\nsudo rpm -Uvh http:\/\/www.elrepo.org\/elrepo-release-7.0-2.el7.elrepo.noarch.rpm\nsudo yum install -y -q kmod-drbd90 drbd90-utils\nsudo yum install -y -q mariadb-server mariadb\nsudo systemctl start pcsd\nsudo systemctl enable pcsd\necho \"nutanix\" | sudo passwd hacluster --stdin\necho -e \"o\\nn\\np\\n1\\n\\n\\nw\" | sudo fdisk \/dev\/sdb\n#fix this\necho '@@{address}@@ node1 ' | sudo tee -a \/etc\/hosts\necho '@@{node2vm.address}@@ node2 ' | sudo tee -a \/etc\/hosts\nsudo systemctl disable mariadb.service\necho \"[mysqld]\"| sudo tee \/etc\/my.cnf\necho \"symbolic-links=0\"| sudo tee -a \/etc\/my.cnf\necho \"bind-address            = 0.0.0.0\"| sudo tee -a \/etc\/my.cnf\necho \"datadir                 = \/var\/lib\/mysql\"| sudo tee -a \/etc\/my.cnf\necho \"pid_file                = \/var\/run\/mariadb\/mysqld.pid\"| sudo tee -a \/etc\/my.cnf\necho \"socket                  = \/var\/run\/mariadb\/mysqld.sock\"| sudo tee -a \/etc\/my.cnf\necho \"[mysqld_safe]\"| sudo tee -a \/etc\/my.cnf\necho \"bind-address            = 0.0.0.0\"| sudo tee -a \/etc\/my.cnf\necho \"datadir                 = \/var\/lib\/mysql\"| sudo tee -a \/etc\/my.cnf\necho \"pid_file                = \/var\/run\/mariadb\/mysqld.pid\"| sudo tee -a \/etc\/my.cnf\necho \"socket                  = \/var\/run\/mariadb\/mysqld.sock\"| sudo tee -a \/etc\/my.cnf\necho \"!includedir \/etc\/my.cnf.d\"| sudo tee -a \/etc\/my.cnf\necho \"resource mysql01 {\"| sudo tee -a \/etc\/drbd.d\/mysql01.res\necho \" protocol C;\"| sudo tee -a \/etc\/drbd.d\/mysql01.res\necho \" meta-disk internal;\"| sudo tee -a \/etc\/drbd.d\/mysql01.res\necho \" device \/dev\/drbd0;\"| sudo tee -a \/etc\/drbd.d\/mysql01.res\necho \" disk   \/dev\/sdb1;\"| sudo tee -a \/etc\/drbd.d\/mysql01.res\necho \" handlers {\"| sudo tee -a \/etc\/drbd.d\/mysql01.res\necho '  split-brain \"\/usr\/lib\/drbd\/notify-split-brain.sh root\";'| sudo tee -a \/etc\/drbd.d\/mysql01.res\necho \" }\"| sudo tee -a \/etc\/drbd.d\/mysql01.res\necho \" net {\"| sudo tee -a \/etc\/drbd.d\/mysql01.res\necho \"  allow-two-primaries no;\"| sudo tee -a \/etc\/drbd.d\/mysql01.res\necho \"  after-sb-0pri discard-zero-changes;\"| sudo tee -a \/etc\/drbd.d\/mysql01.res\necho \"  after-sb-1pri discard-secondary;\"| sudo tee -a \/etc\/drbd.d\/mysql01.res\necho \"  after-sb-2pri disconnect;\"| sudo tee -a \/etc\/drbd.d\/mysql01.res\necho \"  rr-conflict disconnect;\"| sudo tee -a \/etc\/drbd.d\/mysql01.res\necho \" }\"| sudo tee -a \/etc\/drbd.d\/mysql01.res\necho \" disk {\"| sudo tee -a \/etc\/drbd.d\/mysql01.res\necho \"  on-io-error detach;\"| sudo tee -a \/etc\/drbd.d\/mysql01.res\necho \" }\"| sudo tee -a \/etc\/drbd.d\/mysql01.res\necho \" syncer {\"| sudo tee -a \/etc\/drbd.d\/mysql01.res\necho \"  verify-alg sha1;\"| sudo tee -a \/etc\/drbd.d\/mysql01.res\necho \" }\"| sudo tee -a \/etc\/drbd.d\/mysql01.res\necho \" on node1 {\"| sudo tee -a \/etc\/drbd.d\/mysql01.res\necho \"  address  @@{address}@@:7789;\"| sudo tee -a \/etc\/drbd.d\/mysql01.res\necho \" }\"| sudo tee -a \/etc\/drbd.d\/mysql01.res\necho \" on node2 {\"| sudo tee -a \/etc\/drbd.d\/mysql01.res\necho \"  address  @@{node2vm.address}@@:7789;\"| sudo tee -a \/etc\/drbd.d\/mysql01.res\necho \" }\"| sudo tee -a \/etc\/drbd.d\/mysql01.res\necho \"}\"| sudo tee -a \/etc\/drbd.d\/mysql01.res\nsudo sed -i 's\/SELINUX=enforcing\/SELINUX=disabled\/g' \/etc\/selinux\/config","script_type":"sh","type":"","command_line_args":"","login_credential_local_reference":{"kind":"app_credential","name":"centos"}},"timeout_secs":"0","type":"EXEC","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"node1"},"retries":"0","description":"","message_list":[],"child_tasks_local_reference_list":[],"name":"Task2","state":"ACTIVE","attrs":{"expected_response_params":[{"status":"SUCCESS","code":200,"type":""}],"request_body":"{ \"transition\": \"ACPI_SHUTDOWN\" }","headers":[],"url":"https:\/\/10.139.80.40:9440\/PrismGateway\/services\/rest\/v2.0\/vms\/@@{id}@@\/set_power_state\/","response_paths":{},"retry_interval":1,"retry_count":1,"authentication":{"auth_type":"basic","basic_auth":{"username":"admin","password":{"attrs":{"is_secret_modified":false,"secret_reference":{}}}}},"tls_verify":false,"content_type":"application\/json","connection_timeout":120,"type":"","method":"POST"},"timeout_secs":"0","type":"HTTP","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"node1"},"retries":"0","description":"","message_list":[],"child_tasks_local_reference_list":[],"name":"Task3","state":"ACTIVE","attrs":{"type":"","interval_secs":60},"timeout_secs":"0","type":"DELAY","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"node1"},"retries":"0","description":"","message_list":[],"child_tasks_local_reference_list":[],"name":"Task4","state":"ACTIVE","attrs":{"expected_response_params":[{"status":"SUCCESS","code":200,"type":""}],"request_body":"{ \"transition\": \"ON\" }","headers":[],"url":"https:\/\/10.139.80.40:9440\/PrismGateway\/services\/rest\/v2.0\/vms\/@@{id}@@\/set_power_state\/","response_paths":{},"retry_interval":1,"retry_count":1,"authentication":{"auth_type":"basic","basic_auth":{"username":"admin","password":{"attrs":{"is_secret_modified":false,"secret_reference":{}}}}},"tls_verify":false,"content_type":"application\/json","connection_timeout":120,"type":"","method":"POST"},"timeout_secs":"0","type":"HTTP","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"node1"},"retries":"0","description":"","message_list":[],"child_tasks_local_reference_list":[],"name":"Task5","state":"ACTIVE","attrs":{"type":"","interval_secs":180},"timeout_secs":"0","type":"DELAY","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"node1"},"retries":"0","description":"","message_list":[],"child_tasks_local_reference_list":[],"name":"Task7","state":"ACTIVE","attrs":{"exit_status":[],"script":"user = \"@@{pe_username}@@\"\npassword = \"@@{pe_password}@@\"\nip = \"@@{pe_ip}@@\"\nnetworkuuid = \"@@{platform.status.resources.nic_list[0].subnet_reference.uuid}@@\"\n#networkuuid = \"c95d1d97-5dd7-49df-8109-ec799a5c88c1\"\n\ndef process_request(url, method, user, password, headers, payload=None):\n  r = urlreq(url, verb=method, auth=\"BASIC\", user=user, passwd=password, params=payload, verify=False, headers=headers)\n  return r\n\nheaders = {'Accept': 'application\/json', 'Content-Type': 'application\/json'}\n\npayload = {\"length\":500}\nurl = \"https:\/\/\" + ip + \":9440\/api\/nutanix\/v2.0\/networks\/\" + networkuuid\nurl_method = \"GET\"\nr = process_request(url, url_method, user, password, headers)\nprint \"Response Status: \" + str(r.status_code)\nnetwork_json = r.json()\nippool = network_json[\"ip_config\"][\"pool\"][0][\"range\"]\nendofippool = re.sub(\"[^ ]+ \", \"\", ippool)\nprefixip = re.sub(\"\\.[^.]+$\", \"\", endofippool)\npostfixip = re.sub(\"^.*\\.\", \"\", endofippool)\n\nurl = \"https:\/\/\" + ip + \":9440\/api\/nutanix\/v2.0\/networks\/\" + networkuuid + \"\/addresses\"\nurl_method = \"GET\"\nr = process_request(url, url_method, user, password, headers)\nprint \"Response Status: \" + str(r.status_code)\naddresses_json = r.json()\naddresses_list =[]\nfor i in addresses_json[\"entities\"]:\n  addresses_list.append(i[\"ip_address\"])\nprint addresses_list\n\ni = int(postfixip)\nwhile i > 0:\n  address = str(prefixip) + \".\" + str(i)\n  if address in addresses_list:\n    i = i - 1\n  else:\n    break\n\n#reserve ip\npayload = {\"value\":address}\nurl = \"https:\/\/\" + ip + \":9440\/api\/nutanix\/v2.0\/networks\/\" + networkuuid + \"\/blacklist_ip_addresses\"\nurl_method = \"POST\"\nr = process_request(url, url_method, user, password, headers, json.dumps(payload))\nprint \"Response Status: \" + str(r.status_code)\n\nprint \"availableip=\" + address","eval_variables":["availableip"],"eval_scope":"local","type":"","script_type":"static"},"timeout_secs":"0","type":"SET_VARIABLE","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"node1"},"retries":"0","description":"","message_list":[],"child_tasks_local_reference_list":[],"name":"Task6","state":"ACTIVE","attrs":{"exit_status":[],"script":"#!\/bin\/bash\nset -ex\nsudo pcs cluster auth node1 node2 -u hacluster -p nutanix --force\nsudo pcs cluster setup --force --name calmcluster node1 node2\nsudo pcs cluster start --all\nsudo drbdadm create-md mysql01\nsudo drbdadm up mysql01\nsudo drbdadm primary --force mysql01\nsudo mkfs.ext4 -m 0 -L drbd \/dev\/drbd0\nsudo tune2fs -c 30 -i 180d \/dev\/drbd0\nsudo mount \/dev\/drbd0 \/mnt\nsudo systemctl start mariadb\nsudo mysql_install_db --datadir=\/mnt --user=mysql\nsudo umount \/mnt\nsudo systemctl stop mariadb\necho @@{availableip}@@\nsudo pcs cluster cib clust_cfg\nsudo pcs -f clust_cfg property set stonith-enabled=false\nsudo pcs -f clust_cfg property set no-quorum-policy=ignore\nsudo pcs -f clust_cfg resource defaults resource-stickiness=200\nsudo pcs -f clust_cfg resource create mysql_data01 ocf:linbit:drbd drbd_resource=mysql01 op monitor interval=30s\nsudo pcs -f clust_cfg resource master MySQLClone01 mysql_data01 master-max=1 master-node-max=1 clone-max=2 clone-node-max=1 notify=true\nsudo pcs -f clust_cfg resource create mysql_fs01 Filesystem device=\"\/dev\/drbd0\" directory=\"\/var\/lib\/mysql\" fstype=\"ext4\"\nsudo pcs -f clust_cfg constraint colocation add mysql_fs01 with MySQLClone01 INFINITY with-rsc-role=Master\nsudo pcs -f clust_cfg constraint order promote MySQLClone01 then start mysql_fs01\nsudo pcs -f clust_cfg resource create mysql_service01 ocf:heartbeat:mysql binary=\"\/usr\/bin\/mysqld_safe\" config=\"\/etc\/my.cnf\" datadir=\"\/var\/lib\/mysql\" pid=\"\/var\/lib\/mysql\/mysql.pid\" socket=\"\/var\/lib\/mysql\/mysql.sock\" additional_parameters=\"--bind-address=0.0.0.0\" op start timeout=60s op stop timeout=60s op monitor interval=20s timeout=30s\nsudo pcs -f clust_cfg constraint colocation add mysql_service01 with mysql_fs01 INFINITY\nsudo pcs -f clust_cfg constraint order mysql_fs01 then mysql_service01\n#sudo ip a add @@{availableip}@@\/22 dev eth0 \nsudo pcs -f clust_cfg resource create mysql_VIP01 ocf:heartbeat:IPaddr2 ip=@@{availableip}@@ cidr_netmask=22 nic=eth0:1 op monitor interval=30s\nsudo pcs -f clust_cfg constraint colocation add mysql_VIP01 with mysql_service01 INFINITY\nsudo pcs -f clust_cfg constraint order mysql_service01 then mysql_VIP01\nsudo pcs -f clust_cfg constraint\nsudo pcs -f clust_cfg resource show\nsudo pcs --force cluster cib-push clust_cfg\nsudo pcs status","script_type":"sh","type":"","command_line_args":"","login_credential_local_reference":{"kind":"app_credential","name":"centos"}},"timeout_secs":"0","type":"EXEC","variable_list":[]}],"description":"","name":"89aaf42a_runbook","state":"ACTIVE","main_task_local_reference":{"kind":"app_task","name":"1079dabc_dag"},"message_list":[],"variable_list":[]},"type":"","uninstall_runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_package","name":"cluster"},"retries":"0","description":"","message_list":[],"child_tasks_local_reference_list":[{"kind":"app_task","name":"Task1"}],"name":"d3b5131c_dag","state":"ACTIVE","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"node1"},"retries":"0","description":"","message_list":[],"child_tasks_local_reference_list":[],"name":"Task1","state":"ACTIVE","attrs":{"script":"#this script is call Prism Element\nuser = \"@@{pe_username}@@\"\npassword = \"@@{pe_password}@@\"\nip = \"@@{pe_ip}@@\"\navailableip = \"@@{availableip}@@\"\nnetworkuuid = \"@@{platform.status.resources.nic_list[0].subnet_reference.uuid}@@\"\n#availableip = \"10.55.52.116\"\n#networkuuid = \"c95d1d97-5dd7-49df-8109-ec799a5c88c1\"\n\ndef process_request(url, method, user, password, headers, payload=None):\n  r = urlreq(url, verb=method, auth=\"BASIC\", user=user, passwd=password, params=payload, verify=False, headers=headers)\n  return r\n\nheaders = {'Accept': 'application\/json', 'Content-Type': 'application\/json'}\n\n#get end of ip pool\nurl = \"https:\/\/\" + ip + \":9440\/api\/nutanix\/v2.0\/networks\/\" + networkuuid + \"\/blacklist_ip\/\" + availableip\nurl_method = \"DELETE\"\nr = process_request(url, url_method, user, password, headers)\nprint \"Response Status: \" + str(r.status_code)\n#return 204 should be delete successfully","type":"","command_line_args":"","exit_status":[],"script_type":"static"},"timeout_secs":"0","type":"EXEC","variable_list":[]}],"description":"","name":"7d62c46f_runbook","state":"ACTIVE","main_task_local_reference":{"kind":"app_task","name":"d3b5131c_dag"},"message_list":[],"variable_list":[]}},"variable_list":[]},{"description":"","action_list":[],"type":"DEB","service_local_reference_list":[{"kind":"app_service","name":"node2"}],"name":"cluster_cloned_0","version":"","options":{"install_runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_package","name":"cluster_cloned_0"},"retries":"0","description":"","message_list":[],"child_tasks_local_reference_list":[{"kind":"app_task","name":"Task1_cloned_1"},{"kind":"app_task","name":"Task2"},{"kind":"app_task","name":"Task3"},{"kind":"app_task","name":"Task4"},{"kind":"app_task","name":"Task5"},{"kind":"app_task","name":"Task6"}],"name":"1079dabc_dag_cloned_1","state":"ACTIVE","attrs":{"edges":[{"from_task_reference":{"kind":"app_task","name":"Task1_cloned_1"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"Task2"}},{"from_task_reference":{"kind":"app_task","name":"Task2"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"Task3"}},{"from_task_reference":{"kind":"app_task","name":"Task3"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"Task4"}},{"from_task_reference":{"kind":"app_task","name":"Task4"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"Task5"}},{"from_task_reference":{"kind":"app_task","name":"Task5"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"Task6"}}],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"node2"},"retries":"0","description":"","message_list":[],"child_tasks_local_reference_list":[],"name":"Task1_cloned_1","state":"ACTIVE","attrs":{"exit_status":[],"script":"#!\/bin\/bash\nset -ex\nsudo hostnamectl set-hostname node2\nsudo yum update -y -q\nsudo yum install -y -q pcs pacemaker fence-agents-all psmisc policycoreutils-python\nsudo rpm --import https:\/\/www.elrepo.org\/RPM-GPG-KEY-elrepo.org\nsudo rpm -Uvh http:\/\/www.elrepo.org\/elrepo-release-7.0-2.el7.elrepo.noarch.rpm\nsudo yum install -y -q kmod-drbd90 drbd90-utils\nsudo yum install -y -q mariadb-server mariadb\nsudo systemctl start pcsd\nsudo systemctl enable pcsd\necho \"nutanix\" | sudo passwd hacluster --stdin\necho -e \"o\\nn\\np\\n1\\n\\n\\nw\" | sudo fdisk \/dev\/sdb\necho '@@{node1vm.address}@@ node1 ' | sudo tee -a \/etc\/hosts\necho '@@{address}@@ node2 ' | sudo tee -a \/etc\/hosts\nsudo systemctl disable mariadb.service\necho \"[mysqld]\"| sudo tee \/etc\/my.cnf\necho \"symbolic-links=0\"| sudo tee -a \/etc\/my.cnf\necho \"bind_address            = 0.0.0.0\"| sudo tee -a \/etc\/my.cnf\necho \"datadir                 = \/var\/lib\/mysql\"| sudo tee -a \/etc\/my.cnf\necho \"pid_file                = \/var\/run\/mariadb\/mysqld.pid\"| sudo tee -a \/etc\/my.cnf\necho \"socket                  = \/var\/run\/mariadb\/mysqld.sock\"| sudo tee -a \/etc\/my.cnf\necho \"[mysqld_safe]\"| sudo tee -a \/etc\/my.cnf\necho \"bind_address            = 0.0.0.0\"| sudo tee -a \/etc\/my.cnf\necho \"datadir                 = \/var\/lib\/mysql\"| sudo tee -a \/etc\/my.cnf\necho \"pid_file                = \/var\/run\/mariadb\/mysqld.pid\"| sudo tee -a \/etc\/my.cnf\necho \"socket                  = \/var\/run\/mariadb\/mysqld.sock\"| sudo tee -a \/etc\/my.cnf\necho \"!includedir \/etc\/my.cnf.d\"| sudo tee -a \/etc\/my.cnf\necho \"resource mysql01 {\"| sudo tee -a \/etc\/drbd.d\/mysql01.res\necho \" protocol C;\"| sudo tee -a \/etc\/drbd.d\/mysql01.res\necho \" meta-disk internal;\"| sudo tee -a \/etc\/drbd.d\/mysql01.res\necho \" device \/dev\/drbd0;\"| sudo tee -a \/etc\/drbd.d\/mysql01.res\necho \" disk   \/dev\/sdb1;\"| sudo tee -a \/etc\/drbd.d\/mysql01.res\necho \" handlers {\"| sudo tee -a \/etc\/drbd.d\/mysql01.res\necho '  split-brain \"\/usr\/lib\/drbd\/notify-split-brain.sh root\";'| sudo tee -a \/etc\/drbd.d\/mysql01.res\necho \" }\"| sudo tee -a \/etc\/drbd.d\/mysql01.res\necho \" net {\"| sudo tee -a \/etc\/drbd.d\/mysql01.res\necho \"  allow-two-primaries no;\"| sudo tee -a \/etc\/drbd.d\/mysql01.res\necho \"  after-sb-0pri discard-zero-changes;\"| sudo tee -a \/etc\/drbd.d\/mysql01.res\necho \"  after-sb-1pri discard-secondary;\"| sudo tee -a \/etc\/drbd.d\/mysql01.res\necho \"  after-sb-2pri disconnect;\"| sudo tee -a \/etc\/drbd.d\/mysql01.res\necho \"  rr-conflict disconnect;\"| sudo tee -a \/etc\/drbd.d\/mysql01.res\necho \" }\"| sudo tee -a \/etc\/drbd.d\/mysql01.res\necho \" disk {\"| sudo tee -a \/etc\/drbd.d\/mysql01.res\necho \"  on-io-error detach;\"| sudo tee -a \/etc\/drbd.d\/mysql01.res\necho \" }\"| sudo tee -a \/etc\/drbd.d\/mysql01.res\necho \" syncer {\"| sudo tee -a \/etc\/drbd.d\/mysql01.res\necho \"  verify-alg sha1;\"| sudo tee -a \/etc\/drbd.d\/mysql01.res\necho \" }\"| sudo tee -a \/etc\/drbd.d\/mysql01.res\necho \" on node1 {\"| sudo tee -a \/etc\/drbd.d\/mysql01.res\necho \"  address  @@{node1vm.address}@@:7789;\"| sudo tee -a \/etc\/drbd.d\/mysql01.res\necho \" }\"| sudo tee -a \/etc\/drbd.d\/mysql01.res\necho \" on node2 {\"| sudo tee -a \/etc\/drbd.d\/mysql01.res\necho \"  address  @@{address}@@:7789;\"| sudo tee -a \/etc\/drbd.d\/mysql01.res\necho \" }\"| sudo tee -a \/etc\/drbd.d\/mysql01.res\necho \"}\"| sudo tee -a \/etc\/drbd.d\/mysql01.res\nsudo sed -i 's\/SELINUX=enforcing\/SELINUX=disabled\/g' \/etc\/selinux\/config","script_type":"sh","type":"","command_line_args":"","login_credential_local_reference":{"kind":"app_credential","name":"centos"}},"timeout_secs":"0","type":"EXEC","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"node2"},"retries":"0","description":"","message_list":[],"child_tasks_local_reference_list":[],"name":"Task2","state":"ACTIVE","attrs":{"expected_response_params":[{"status":"SUCCESS","code":200,"type":""}],"request_body":"{ \"transition\": \"ACPI_SHUTDOWN\" }","headers":[],"url":"https:\/\/10.139.80.40:9440\/PrismGateway\/services\/rest\/v2.0\/vms\/@@{id}@@\/set_power_state\/","response_paths":{},"retry_interval":1,"retry_count":1,"authentication":{"auth_type":"basic","basic_auth":{"username":"admin","password":{"attrs":{"is_secret_modified":false,"secret_reference":{}}}}},"tls_verify":false,"content_type":"application\/json","connection_timeout":120,"type":"","method":"POST"},"timeout_secs":"0","type":"HTTP","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"node2"},"retries":"0","description":"","message_list":[],"child_tasks_local_reference_list":[],"name":"Task3","state":"ACTIVE","attrs":{"type":"","interval_secs":60},"timeout_secs":"0","type":"DELAY","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"node2"},"retries":"0","description":"","message_list":[],"child_tasks_local_reference_list":[],"name":"Task4","state":"ACTIVE","attrs":{"expected_response_params":[{"status":"SUCCESS","code":200,"type":""}],"request_body":"{ \"transition\": \"ON\" }","headers":[],"url":"https:\/\/10.139.80.40:9440\/PrismGateway\/services\/rest\/v2.0\/vms\/@@{id}@@\/set_power_state\/","response_paths":{},"retry_interval":1,"retry_count":1,"authentication":{"auth_type":"basic","basic_auth":{"username":"admin","password":{"attrs":{"is_secret_modified":false,"secret_reference":{}}}}},"tls_verify":false,"content_type":"application\/json","connection_timeout":120,"type":"","method":"POST"},"timeout_secs":"0","type":"HTTP","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"node2"},"retries":"0","description":"","message_list":[],"child_tasks_local_reference_list":[],"name":"Task5","state":"ACTIVE","attrs":{"type":"","interval_secs":60},"timeout_secs":"0","type":"DELAY","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"node2"},"retries":"0","description":"","message_list":[],"child_tasks_local_reference_list":[],"name":"Task6","state":"ACTIVE","attrs":{"exit_status":[],"script":"#!\/bin\/bash\nset -ex\nsudo drbdadm create-md mysql01\nsudo drbdadm up mysql01","script_type":"sh","type":"","command_line_args":"","login_credential_local_reference":{"kind":"app_credential","name":"centos"}},"timeout_secs":"0","type":"EXEC","variable_list":[]}],"description":"","name":"89aaf42a_runbook_cloned_0","state":"ACTIVE","main_task_local_reference":{"kind":"app_task","name":"1079dabc_dag_cloned_1"},"message_list":[],"variable_list":[]},"type":"","uninstall_runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_package","name":"cluster_cloned_0"},"retries":"0","description":"","message_list":[],"child_tasks_local_reference_list":[],"name":"d3b5131c_dag_cloned_1","state":"ACTIVE","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"7d62c46f_runbook_cloned_0","state":"ACTIVE","main_task_local_reference":{"kind":"app_task","name":"d3b5131c_dag_cloned_1"},"message_list":[],"variable_list":[]}},"variable_list":[]}],"app_profile_list":[{"deployment_create_list":[{"type":"GREENFIELD","action_list":[],"depends_on_list":[],"name":"b84a2406_deployment","published_service_local_reference_list":[],"max_replicas":"1","package_local_reference_list":[{"kind":"app_package","name":"cluster"}],"substrate_local_reference":{"kind":"app_substrate","name":"node1vm"},"min_replicas":"1","variable_list":[],"description":""},{"type":"GREENFIELD","action_list":[],"depends_on_list":[],"name":"b84a2406_deployment_cloned_0","published_service_local_reference_list":[],"max_replicas":"1","package_local_reference_list":[{"kind":"app_package","name":"cluster_cloned_0"}],"substrate_local_reference":{"kind":"app_substrate","name":"node2vm"},"min_replicas":"1","variable_list":[],"description":""}],"description":"","action_list":[],"name":"Default","variable_list":[{"val_type":"STRING","description":"","name":"pe_username","type":"LOCAL","value":"admin","label":""},{"val_type":"STRING","description":"","name":"pe_password","type":"LOCAL","value":"Nutanix@123","label":""},{"val_type":"STRING","description":"","name":"pe_ip","type":"LOCAL","value":"10.139.80.40","label":""}]}],"published_service_definition_list":[],"default_credential_local_reference":{"kind":"app_credential","name":"centos"},"type":"USER"},"name":"PCS_DRBD90_MySQL_2node_cluster"},"api_version":"3.0","metadata":{"last_update_time":"1556168607786348","kind":"blueprint","spec_version":0,"creation_time":"1556168607786348","name":"PCS_DRBD90_MySQL_2node_cluster"}}